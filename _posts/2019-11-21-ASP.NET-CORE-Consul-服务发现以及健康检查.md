##ASP.NET CORE使用Consul实现服务治理与健康检查

####背景
笔者所在的公司正在进行微服务改造，这其中服务治理组件是必不可少的组件之一，在一番讨论之后，最终决定放弃 Zookeeper 而采用 Consul 作为服务治理框架基础组件。主要原因是 Consul 自带健康检查，通过该功能可以比较方便的监控应用的运行状态，从而更好的运维整个系统。但在实际实施过程中笔者发现，目前网络上所能看到的很多资料，没有比较清晰的解释 Consul 的运行方式，特别是当用户对于 Zookeeper 主动通知的方式比较熟悉之后，对于 Consul 这种每次都通过 HTTP 调用获取服务信息的方式还是存在很多疑惑的，比如：这样的方式在调用链中，不是会导致 HTTP 调用链增加一倍吗？

#### Consul介绍
关于Consul，首先介绍最常见的一副图：
![consul1](/img/consul1.png)
该图表示 Consul 支持的一个重要的功能———多数据中心，这也是很多服务注册发现工具所不具备的，通过上述图中我们可以解读出如下一些信息：
1. Cosnul 分为 Server 和 Client，多数据中心的实现主要依靠两个数据中心的 Server 进行通信，并且每个数据中心有各自的主节点，也就是各自选举。
2. Client 与 Server 之间通过8300端口，TCP协议进行RPC交互。
3. Client 与其他 Agent 之间通过 8301 以 TCP/UDP 协议进行 LAN GOSSIP 交互
> 说明：Client 与其他实例之间的通信，这里其实有一个反熵概念，具体可参考园子里 [波斯码](https://www.cnblogs.com/bossma/tag/Consul/) 所写的文章——[Consul的反熵](https://www.cnblogs.com/bossma/p/11354245.html)，此文章对于反熵概念的解释非常到位，在笔者对于 Consul 的学习阶段，也跟 波斯码 同学私信沟通多轮，他都一一耐心解答，在此一并表示感谢！