## .NET CORE2.2下 Ocelot+Consul服务发现遇到的问题

历史原因，笔者所在公司的项目目前还在使用 .NET CORE 2.2版本，在所有业务应用升级完成服务注册发现之后，最后剩下 Ocelot 网关服务升级。在升级过程中，遇到一些问题，记录此文，以便有相同情况的同学参考。

#### 简单说下升级步骤

[根据官方文档](https://ocelot.readthedocs.io/en/latest/features/servicediscovery.html#consul) ,通过简单的添加配置，既可以将原有配置方式改为服务发现：

1. 安装插件
Install-Package Ocelot.Provider.Consul

2. 配置服务
```
s.AddOcelot()
    .AddConsul();
```

3. 添加全局配置文件
```
"ServiceDiscoveryProvider": {
    "Host": "localhost",
    "Port": 8500,
    "Type": "Consul"
}
```
4. 配置路由
```
{
    "DownstreamPathTemplate": "/api/values}",
    "DownstreamScheme": "https",
    "UpstreamPathTemplate": "/spider/api/values",
    "UpstreamHttpMethod": [ "Get" ],
    "ServiceName": "spider",
    "LoadBalancerOptions": {
        "Type": "LeastConnection"
    },
}
```
简单的几个步骤，Ocelot 升级完成，然而经过测试，却发现 Ocelot 并没有向我们预期那样，路由到后端的服务，而是报如下错误：
![](https://raw.githubusercontent.com/xBoo/xboo.github.com/master/img/oc_error.png)